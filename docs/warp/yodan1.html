<HTML>
<HEAD><TITLE>YODAN part 1 of NYAOS</TITLE></HEAD>
<BODY bgcolor="#000000" text="#FFFFFF" link="#00FF00" vlink="#00AA00" alink = "#FF0000">
<CENTER>
<TABLE BORDER=10>
<TR><TD><FONT SIZE=+2>葉山文書</FONT><BR>7/16〜8/13の戯事篇</TD>
</TABLE>
</CENTER>
<UL>
  <li> <a href="#comments">拡張属性のコメント</a>(8/13)
  <li> <a href="#fd">FDもどき</a>(8/13)
  <li> <a href="#hidden">Hiddenファイルの扱い</a>(8/13)
  <li> <a href="#tenkai">入力行の展開・置換</a>(8/11)
  <li> <a href="#hpfs">HPFSの悲劇？</a>(8/10)
  <li> <a href="#dosvpathsos">DOSVPATH と SOS</a>(8/10)
  <li> <a href="#bug123">NYAOS 1.23 バグ報告(8/8,9)</a>
  <li> <a href="#brokencount">ページのカウンタを破壊してしまった</a>(8/4)
  <li> <a href="#history">ただ今、ヒストリを改良中</a>(7/30)
  <li> <a href="#rmseg">Segmentation Fault がとれた、よかったよかった</a>(7/26)
</UL>
<img alt="▽" src="/image/s11.gif"><a href="yodan.html">目次へ</a>
<hr>

<h3><a name="comments">拡張属性のコメント</a>(8/13)</h3>

OS/2 の拡張属性には「.COMMENT」というのがありまして、
これにコメントを入れることができます。
WPSでは、プロパティ(設定ノートブック)のファイルの3ページ目で
読み書きすることができる他、REXXなんかでも簡単に
扱うことができます。
<P>
僕も eadir などという内蔵コマンドを作ったものですが、
そのせいか、OS/2 mag.で、REXXでコメントを扱う記事が
出る度に「NYAOS は .COMMENT の扱いがしやすいぞー」
と叫んでしまいます。（だったら、メイルでも送れよと自分でも思うが、勇気がないので、
今度、葉書を出そう(笑)）
<P>
そういえば、lha の書庫のレベル2形式にはコメントヘッダというものがあるそうです。
これに「.COMMENT」の内容を保存するようにできないものでしょうかねぇ。
「-e」オプションでも保存できますが、そうすると希望しない拡張属性(アイコン、REXXのキャッシュ情報)
まで保存されてしまいますから、サイズが大きくなってしまう場合があります。
ちょっとしたことですが、できたらうれしいのですがねぇ。
（だったら、作者の<a href="http://ux01.so-net.or.jp/~hiramatu/">平松さん</a>
へメイルを送れよと自分でも思うが、
一般にメジャーなフリーウェアの作者はこの手のメイルでメイルボックスがあふれて
迷惑していると聞くし<TT>...</TT>。
あ、僕宛は全然歓迎っす（その前にメジャーぢゃない））。
<PRE>
# しかし、lha は ヘッダ識別子に1byteしか取っていないのは、
# 明らかに間違いだと思う。
# ここは、OSのid×256を足した2bytesにすべきだっただろう。
</PRE>
しかし、せっかく、コメントの属性にファイルの説明を付けても、
Muleでエディットすると、消えてしまうんですよねぇ。
（正確には「<TT>foo</TT>」というファイルをエディットすると、
「<TT>foo~</TT>」に移ってしまう）
<P>
拡張属性は使ってはいけないものなんだろうか<TT>...</TT>

<hr>
<h3><a name="fd">FDもどき</a>(8/13)</h3>

僕は基本的にコマンドライン派なんですが、それでも、
大量のファイルを整理する場合などには、FDライクな tool、
Solaris では FDclone、OS/2 では Filestar を使っています。
で、FDclone の方には何の問題もないのですが、Filestar は
UNIX的なキー操作ができなくて、ちょっと不満です
(カーソルの点滅も消しちまうし)。
<P>
OS/2 には、他に KL とか FD/2 とかがありますけど、
そのいづれも、C-n,C-p どころか、ダイヤモンドカーソルすら
サポートしていないのは、なぜなんでしょうかねぇ。
英語圏に行けばあるかもしれませんが、あの枠線が化けるのは
みっともなくて嫌ですしねぇ(AXの呪い)。
PM用は、起動する度にディスクがカリカリ言うし<TT>...</TT>
<P>
これは俺がやるしかないのかな。
今なら、その筋の人のシェアを独占できるかも。<BR>
<TT># </TT>実は、もはや、そんな暇はないが<TT>...</TT><BR>

<hr>
<h3><a name="hidden">Hiddenファイルの扱い</a></h3>

「<TT>ls .*</TT>」は(非公開版では)直ったわけですが、Hiddenファイルについては、
-a 付きでファイル名を直接指定してもだめなようです。
これは、emx/gcc の _fnexplode関数の仕様で仕方無いみたいです。<BR>
　そういえば、新出先生の(DOS用の)UNIX tools では、
「_」で始まるファイルは表示しないという仕様があります。
採用しましょうかねぇ(まぁ、option切り替えすればいいけど)。<BR>
　あと、内蔵ls にないオプションを使用した場合、外部の ls を呼び出す
ようにしなければまずいかなぁとも思っております。cshの「<TT>ls-F</TT>」
などは、おそらくそのような仕様になっていたような気がします。
そうすると、従来の独自オプションとの互換性はどうすればいいでしょうかねぇ。
(8/13)

<hr>

<h3><a name="tenkai">入力の展開・置換</a></h3>
NYAOS では、入力行を
<ol>
  <li> エイリアス展開
  <li> ヒストリ , 環境変数 , 「~」「&amp;」「&amp;&amp;」「||」
  <li> (内蔵コマンドか否かのcheck &amp; 実行)
  <li> スクリプト展開
</ol>
の順に置換しています。<BR>
<BLOCKQUOTE>
<FONT COLOR="#FF00FF">
(補足)<BR>
　あとから、ソースを見たら、「&amp;」「&amp;&amp;」「||」など、
命令の区切文字に関しては、スクリプト展開のルーチンでやってました。<BR>
</FONT>
</BLOCKQUOTE>
ですが、「続・たのしいUNIX」を見たところ、これは
<ol>
  <li> ヒストリ , 環境変数 , 「~」
  <li> エイリアス
  <li> スクリプト展開 ,「&amp;」「&amp;&amp;」「||」
</ol>
とすべきようです。
<BR>
　下手をすると、バグが噴出しかねませんが、現在のままでは、
ヒストリで「エイリアスを使った過去の入力」を参照できませんし、
「&amp;&amp;」の後のスクリプト名も実行できません。
前から気になっていたことだけに、ぼちぼちやろうと思います。
(8/11)

<hr>

<h3><a name="hpfs">HPFS の悲劇？</a></h3>

<a href="http://www.asahi-net.or.jp/~FV6N-TNSK/gates/">がんばれ!! Gates君</a>という
マイクロソフトの悪徳商法を紹介しているウェブページの最新号に
<a href="http://www.asahi-net.or.jp/~FV6N-TNSK/gates/fat4.html">MSファイルシステムの怪（完結編）〜ＨＰＦＳの悲劇</a>
とページが登場しました。ううむ、NTFS というのは、HPFS と違い、遅いんですねぇ。
しかし「HPFSが消えさるのはあわれでならない」というのは、ちょっとなー。
<P>
そういえば、次の Warp 5 では、ドライブレターが消えるという話をどっかの雑誌で読んだ記憶がありますが、
本当なんでしょうかねぇ。ついでに、ハード/シンボリックリンクもサポートしてくれたらよいのですが。
<P>
<BLOCKQUOTE>
<FONT COLOR="#FF00FF">
(補足)<BR>
Journaling File System for Warp とかいうそうです。
AIXからの移植で、Server用だそうです(ちと残念)
(<a href="http://www.os2ss.com/Information/Warp5">http://www.os2ss.com/Information/Warp5</a>)。
<BR>
　わざわざ、メイルで教えてくださいました宇野さんに
お礼申しあげます。
（NYAOSのバグリポートとかもよくいただき、
非常に助かってます。<TT>m(__)m</TT>）<BR>
</FONT>
</BLOCKQUOTE>

<hr>

<h3><a name="dospath">DOSVPATH と SOS</a></h3>

最近、DOSについてほとんど意識していなかったのですが、
OS/2窓で、日本語のDOSソフトを起動させてしまうと、
英語環境で起動してしまいます。
<P>
IBMEWS の startdos を使えば、日本語環境で起動できますが、
いちいち「<TT>startdos ... 実行ファイル名</TT>」と入力するのも
結構、うっとうしいですね。しかし、これは<TT>...</TT>、
おお、SCRIPTPATHと同じ方法で解決できるではないか！
なぜ、今まで思いつかなかったんだろう(と思ったのが一ヶ月前)。
<P>
ここは、<TT>DOSVPATH</TT>なる環境変数に記述されているディレクトリ内に
ある実行ファイルについては「startdos ...」を直前に付加するように
すればよいわけですね。しかし、入力の度に検索するディレクトリの数が
増えるわけですから、さらに速度が遅くなるかもしれません。
<P>
やはり、ここは独自キャッシュを用意した方がよさそうです。
いくらディスクキャッシュで実際にディスクとアクセスしないといえども、
毎回 opendir で検索するのも、不経済です。
ここは ハッシュテーブル を用意して、検索速度を稼ぐのが、
正しいプログラマの態度でしょう。
でも、SCRIPT実行支援を On にした時でも、さほど速度低下は感じられないしなー。
いらぬ改造をして、またバグを大量噴出させるのはなー。
ううむ、あ、そういう時こそ、option 選択か！
<P>
まぁ、どっちにしても、DOSVPATH はやります。この他、前から
アナウンスしていて、全然やっていないものに SOS スクリプトの
OS/2窓実行機能というのがあります。SOSというのは言語ぢゃなくて、
DOS上で「#!」機能を実現するソフトウェアです。といっても、
常駐プログラムとかではなくて、スクリプトファイルの先頭に
挿入して、拡張子を COM に変えれば、そのまま実行ファイルに
なってしまうという テキスト型の実行ファイルのヘッダです。
最新版は<a href="ftp://ftp.ics.nara-wu.ac.jp/pub/dosutil/">ftp://ftp.ics.nara-wu.ac.jp/pub/dosutil/</a>
から Get できるはずです。
作られたのは、奈良女子大学の<a href="http://www.ics.nara-wu.ac.jp/~nide/">新出尚之先生</a>です。
実は昔、先生の講義(京大教養の情報処理実習)を受けたことがあり、
awk やシェルスクリプトの便利さを教えていただきました。
<P>
この SOS で作ったCOM型スクリプトというのは、OS/2窓でも全く問題
実行でき、OS/2コマンドともパイプがちゃんとつながるのですが、
いかんせん、PC-DOS窓を毎回開くので、ちょっとスムーズとはいえないのです。
ここは NYAOS の出番かなぁと思うのですが、実際に
それほど Needs があるのかが疑問なんで、
まだ、手が動くには至ってません。
あと、SOSスクリプトと普通のCOMファイルの判別に
時間がかかりそうだというのもあるんですよね。
<P>
でも、まぁ、このへんは、近々登場すると言われている、
TCSH OS/2日本語版に唯一対抗できそうな点なんで、
避けては通れません。まぁ、1.24 か 1.25 くらいで、
なんとかしたいですね(いっそーのこと、1.30 に格上げするか！)。

<hr>

<h3><a name="bug123">NYAOS 1.23 バグ報告</a></h3>

例によって、不具合がいくらか判明しました。
(バグというほどのものではない<TT>...</TT>と思いたい)
<ul>
  <li> 「<tt>!</tt><i>str</i>」,「<tt>!</tt>番号」で
       該当しない history を参照した場合に、
       エラーも何も表示してません。
       ちょっと、不親切でした。
  <li> 「<tt>ls .*</tt>」で何も表示されないという不具合がありました。
       「<tt>ls -a .*</tt>」ならば表示できますが、本来「<tt>-a</tt>」は要らないはずです。
  <li> 「<tt>cd Os2</tt>」と入力する(補完ではない)と、実際のディレクトリは「<tt>OS2</tt>」なのに、
       プロンプトでは「<tt>Os2</tt>」となってしまう。
</ul>
1.23 で新規に現れたわけではなりませんが、
次の Release では何とかしたいと思います。<BR>
(8/8:深夜)
<P>
上で、「ls .*」と「!」のメッセージの件については、
簡単に直りました。次のバージョンでは、ばっちりです。
<BR>(8/9:朝)

<hr>

<h3><a name="brokencount">ページのカウンタを破壊してしまった</a>(8/4)</h3>

このページ(nyaosのページ)のカウント数を記録したファイルを誤って破壊してしまいました。
で、何回だったのか、分からなくなってしまったので、とりあえず、
920回くらいにしときます。httpd のログファイルに「<tt>grep &amp; wc</tt>」を
かけたところ「1106」と出たのですが、これをそのまま使ったんじゃ、
感動の 1000 回がなくなってしまいますしね、って自己満足の世界です...
<nobr>:-)</nobr>

<hr>

<H3><a name="history">ただ今、ヒストリを改良中</a>(7/30)</H3>

　放りっぱなしだった、ヒストリ関係を今、やっています。
本来、仕様がバグしてる「!」の方を先にやるべきなのですが、
つい趣味が走って、Bash-like のインクリメンタルなヒストリ参照を
まずやっています(ほぼ完成)。
<BR>
　もちろん、「!」を放りっぱなしにするつもりはありません。
今度は間違えないよう、cshの「!」の仕様を調べていますので、
少々お待ちくださいませ。
<P>
　カーソルの件は、どう対処したらいいか、困っているという状況です。
カーソルを On にするには、v_ctypeという関数を呼び出せばいいのですが、
これには二つの引数(カーソル開始ライン、カーソル終了ラインだったと思う)を
渡さなければいけません。で、これが <tt>mode coXX,YY</tt>の YY によって、
適切な値が変わってしまうようなんです。v_getctype という関数でこの値を
得られるのですが、これをいつ実行するかをちょっと悩んでいます。
どなたか助言をくださいませ。なお、点滅でないカーソルでも構わないなら、
<PRE>
    cursor 0;47;30 1;37;40
</PRE>
で、ニセカーソルを利用することもできます。
<P>

<hr>

<h3><a name="rmseg">Segmentation Fault がとれた、よかったよかった</a></h3>

日本語のバグを直したら、emxライブラリ中で Segmentation Fault が発生し
たと、<a href="#cantjap">前</a>に書きましたが、
gdb を使わず、古典的な printf デバッグを行なった結果、
置換ルーチンの一部で無限ループになっている部分があるところが見付かり、
万事解決しました。
<P>
しかし、なぜ今まで、このバグが発生しなかったのか不思議だ。
<HR>
<img alt="▽" src="/image/s11.gif"><a href="yodan0.html">さらに過去の余談へ</a>
</body>
</html>
